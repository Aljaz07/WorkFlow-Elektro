<!DOCTYPE html>
<html lang="sl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>WorkFlow Elektro</title>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.js"></script>
<!-- jsPDF + autotable for PDF export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<style>
:root{
  --bg-1:#0b0c0f; --bg-2:#0f1720; --panel:#0f1b17; --accent:#ffc400; --muted:#bfc8c1; --card:#08120f;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial; background:linear-gradient(180deg,var(--bg-1),var(--bg-2)); color:#eef6ee}
/* LOGIN */
.login-wrap{display:flex;align-items:center;justify-content:center;height:100vh;padding:20px}
.login-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:28px;border-radius:14px; width:360px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,196,0,0.06)}
.login-card h2{color:var(--accent);margin:0 0 10px}
.login-card input{width:100%;padding:12px;margin:8px 0;border-radius:8px;border:none;background:#0e1915;color:#fff}
.btn{background:var(--accent);color:#07100a;padding:10px 14px;border-radius:10px;border:none;font-weight:700;cursor:pointer}
.small{font-size:13px;color:var(--muted)}
/* APP */
.app{display:none;height:100vh;overflow:hidden}
.app.active{display:flex}
.left{width:300px;min-width:240px;background:linear-gradient(180deg, rgba(255,255,255,0.02),rgba(255,255,255,0.01));padding:22px;border-right:1px solid rgba(255,196,0,0.04);display:flex;flex-direction:column}
.logo{display:flex;gap:12px;align-items:center}
.logo .dot{width:48px;height:48px;border-radius:12px;background:var(--accent);display:flex;align-items:center;justify-content:center;color:#07100a;font-weight:800}
.sidebar-btn{display:block;width:100%;text-align:left;padding:12px 14px;border-radius:10px;background:transparent;color:var(--muted);border:none;cursor:pointer;font-weight:600;margin-top:8px}
.sidebar-btn.active,.sidebar-btn:hover{background:rgba(255,196,0,0.06);color:#fff}
.user-info{margin-top:auto;display:flex;align-items:center;gap:10px;padding-top:12px;border-top:1px solid rgba(255,196,0,0.03)}
.avatar{width:48px;height:48px;border-radius:8px;background:#142018;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:700}
.right{flex:1;display:flex;flex-direction:column;padding:18px;gap:12px;overflow:auto}
.topbar{display:flex;justify-content:space-between;align-items:center}
.calendar-surface{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.0));border-radius:12px;padding:14px;box-shadow:0 8px 30px rgba(0,0,0,0.45);border:1px solid rgba(255,196,0,0.03);display:flex;flex-direction:column;gap:12px;min-height:70vh}
.cal-header{display:flex;align-items:center;justify-content:space-between}
.cal-nav{display:flex;gap:8px;align-items:center}
.month-label{font-weight:700;color:#fff;padding:8px 14px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02)}
.weekdays{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
.weekday{text-align:center;font-weight:700;color:var(--muted);font-size:13px;padding:6px 8px}
.calendar{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;flex:1;align-content:start}
.cell{background:#07120f;padding:10px;border-radius:10px;min-height:120px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px;position:relative;transition:transform .15s ease, box-shadow .15s ease}
.cell:hover{transform:translateY(-4px);box-shadow:0 8px 30px rgba(0,0,0,0.6)}
.date-badge{font-weight:700;color:var(--accent);font-size:13px}
.task{background:linear-gradient(180deg, rgba(255,196,0,0.08), rgba(255,196,0,0.06));color:#07100a;padding:8px;border-radius:8px;font-weight:700;font-size:13px;display:flex;justify-content:space-between;align-items:center;gap:8px;border-left:4px solid rgba(0,0,0,0.12);cursor:pointer}
.note{font-size:13px;color:var(--muted)}
/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(2,6,4,0.6);display:none;align-items:center;justify-content:center;padding:18px;z-index:40}
.modal{background:#07120f;padding:18px;border-radius:12px;max-width:720px;width:100%;box-shadow:0 20px 50px rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.03)}
.form-row{display:flex;gap:10px}
.form-row > *{flex:1}
.time-list{margin-top:8px;display:flex;flex-direction:column;gap:8px}
.time-item{display:flex;gap:8px;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:#08120f}
.time-item button{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 8px;border-radius:8px;cursor:pointer}
.export-row{display:flex;gap:8px}
/* responsive */
@media (max-width:900px){.left{display:none}.calendar{grid-template-columns:repeat(2,1fr)}.weekdays{display:none}}
@media (max-width:480px){.calendar{grid-template-columns:repeat(1,1fr)}}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginWrap" class="login-wrap">
  <div class="login-card">
    <h2>ElektroWorks</h2>
    <input id="loginUser" placeholder="Uporabniško ime" />
    <input id="loginPass" type="password" placeholder="Geslo" />
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn" onclick="doLogin()">Prijava</button>
    </div>
  </div>
</div>

<!-- APP -->
<div id="app" class="app">
  <div class="left">
    <div class="logo"><div class="dot">E</div><div><h3>ElektroWorks</h3><div class="note">Upravljanje delovnih nalog</div></div></div>

    <div style="margin-top:16px">
      <button id="btnCal" class="sidebar-btn active" onclick="showPanel('calendar')">Koledar</button>
      <button id="btnTasks" class="sidebar-btn" onclick="showPanel('tasks')">Seznam nalog</button>
      <button id="btnHistory" class="sidebar-btn" onclick="showPanel('history')">Zgodovina</button>
      <button id="btnStats" class="sidebar-btn" onclick="showPanel('stats')">Statistika</button>
    </div>

    <div class="spacer"></div>

    <div class="user-info">
      <div class="avatar" id="avatarBox">A</div>
      <div>
        <div id="userName">—</div>
        <div class="note" id="userRole">—</div>
      </div>
      <div style="flex:1"></div>
      <button class="sidebar-btn" style="background:transparent;border:1px solid rgba(255,255,255,0.03);margin-left:8px" onclick="logout()">Odjava</button>
    </div>
  </div>

  <div class="right">
    <div class="topbar"><h2 id="pageTitle">Koledar nalog</h2>
      <div style="display:flex;gap:8px;align-items:center">
        <div class="chip" id="todayChip" style="cursor:pointer" onclick="goToday()">Pojdi na danes</div>
      </div>
    </div>

    <!-- CALENDAR SURFACE -->
    <div id="calendarSurface" class="calendar-surface">
      <div class="cal-header">
        <div class="cal-nav">
          <button class="btn" onclick="prevMonth()">◀</button>
          <div class="month-label" id="monthLabel"></div>
          <button class="btn" onclick="nextMonth()">▶</button>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div class="note">Klikni na dan za dodajanje (samo direktor). Klik na kartico odpre modal za zaključevanje.</div>
          <div style="width:10px"></div>
          <div class="export-row">
            <button class="btn" onclick="exportCSV()">Export CSV</button>
            <button class="btn" onclick="exportPDF()">Export PDF</button>
          </div>
        </div>
      </div>

      <div class="weekdays" id="weekDays">
        <div class="weekday">N</div><div class="weekday">P</div><div class="weekday">T</div><div class="weekday">S</div><div class="weekday">Č</div><div class="weekday">P</div><div class="weekday">S</div>
      </div>

      <div id="calendarGrid" class="calendar"></div>
    </div>

    <!-- TASKS PANEL -->
    <div id="tasks" class="calendar-surface" style="display:none">
      <h3>Seznam aktivnih nalog</h3>
      <div id="taskListPanel"></div>
    </div>

    <!-- HISTORY PANEL -->
    <div id="history" class="calendar-surface" style="display:none">
      <h3>Zgodovina</h3>
      <div id="historyPanel"></div>
    </div>

    <!-- STATS PANEL -->
    <div id="stats" class="calendar-surface" style="display:none">
      <h3>Statistika</h3>
      <div id="statsPanel"></div>
    </div>
  </div>
</div>

<!-- ADD TASK MODAL -->
<div id="addModal" class="modal-backdrop">
  <div class="modal">
    <h3>Dodaj nalog <span id="modalDayLabel" style="color:var(--accent)"></span></h3>
    <div style="display:flex;gap:10px;margin-bottom:8px"><input id="newTitle" placeholder="Naziv naloge" /><input id="newDate" type="date" /></div>
    <textarea id="newDesc" rows="3" placeholder="Opis naloge" style="width:100%;padding:10px;border-radius:8px;background:#0e1915;border:none;color:#fff"></textarea>
    <div style="display:flex;gap:10px;margin-top:8px"><select id="newWorker" style="padding:10px;border-radius:8px;background:#0e1915;border:none;color:#fff"></select><input id="newColor" type="color" value="#ffc400" style="height:44px;border-radius:8px;padding:6px;border:none" /></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button class="btn" onclick="saveNewTask()">Shrani</button>
      <button class="btn" style="background:transparent;color:var(--accent);border:1px solid rgba(255,196,0,0.06)" onclick="closeAddModal()">Prekliči</button>
    </div>
  </div>
</div>

<!-- COMPLETE MODAL (intervals) -->
<div id="completeModal" class="modal-backdrop">
  <div class="modal">
    <h3>Zaključi nalogo: <span id="completeTitle" style="color:var(--accent)"></span></h3>
    <div class="note">Vnesi enega ali več intervalov (npr. 07:00–10:00 in 11:00–20:00). Sistem prepreči prekrivanja.</div>
    <div class="time-list" id="timeList"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <input id="startInput" type="time" />
      <input id="endInput" type="time" />
      <button class="btn" onclick="addTimeRow()">Dodaj interval</button>
    </div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:12px">
      <button class="btn" onclick="submitComplete()">Potrdi in zaključi</button>
      <button class="btn" style="background:transparent;color:var(--accent);border:1px solid rgba(255,196,0,0.06)" onclick="closeCompleteModal()">Zapri</button>
    </div>
  </div>
</div>

<script>
// Demo users
const demoUsers = { admin:{pass:'Outside2025',role:'admin',name:'Direktor'}, aljaž:{pass:'SnowWinter2025',role:'worker',name:'Aljaž'}};
// Storage keys
const KEY_WORKERS='ew_workers_v1', KEY_TASKS='ew_tasks_v1', KEY_HISTORY='ew_history_v1';
let workers = JSON.parse(localStorage.getItem(KEY_WORKERS) || JSON.stringify({ aljaž:{name:'Aljaž',role:'worker'}));
let tasks = JSON.parse(localStorage.getItem(KEY_TASKS) || '[]');
let history = JSON.parse(localStorage.getItem(KEY_HISTORY) || '[]');
let currentUser=null, currentRole=null, currentDate=new Date(), modalAddDate=null, completingIndex=null;

function saveAll(){ localStorage.setItem(KEY_WORKERS, JSON.stringify(workers)); localStorage.setItem(KEY_TASKS, JSON.stringify(tasks)); localStorage.setItem(KEY_HISTORY, JSON.stringify(history)); }
function formatDate(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }
function parseTimeToHours(t){ const [hh,mm]=t.split(':').map(Number); return hh + mm/60; }
function diffHours(s,e){ return Math.max(0, Math.round((parseTimeToHours(e)-parseTimeToHours(s))*100)/100); }
function humanDuration(d){ const h=Math.floor(d); const m=Math.round((d-h)*60); if(h===0) return `${m}m`; if(m===0) return `${h}h`; return `${h}h ${m}m`; }

/* ---------------- LOGIN ---------------- */
function fillDemo(){ document.getElementById('loginUser').value='admin'; document.getElementById('loginPass').value='Outside2025'; }
function doLogin(){ const u=document.getElementById('loginUser').value.trim().toLowerCase(); const p=document.getElementById('loginPass').value; if(demoUsers[u] && demoUsers[u].pass===p){ currentUser=u; currentRole=demoUsers[u].role; afterLogin(); } else { alert('Napačni podatki.'); } }
function afterLogin(){ document.getElementById('loginWrap').style.display='none'; document.getElementById('app').classList.add('active'); document.getElementById('userName').textContent = demoUsers[currentUser].name; document.getElementById('userRole').textContent = currentRole; document.getElementById('avatarBox').textContent = demoUsers[currentUser].name.slice(0,1).toUpperCase(); document.getElementById('roleChip')?.remove?.(); renderMonth(); renderCalendar(); renderTasksPanel(); renderHistoryPanel(); renderStatsPanel(); populateWorkerSelect(); // hide add for workers
 if(currentRole !== 'admin'){ document.querySelectorAll('.sidebar-btn').forEach(b=>{ if(b.id==='btnTasks') b.style.display='none'; }); }
}
function logout(){ location.reload(); }

/* ---------------- PANELS ---------------- */
function showPanel(name){ const panelMap={calendar:'calendarSurface', tasks:'tasks', history:'history', stats:'stats'}; Object.values(panelMap).forEach(id=>document.getElementById(id).style.display='none'); const toShow = panelMap[name]||'calendarSurface'; document.getElementById(toShow).style.display='flex'; document.querySelectorAll('.sidebar-btn').forEach(b=>b.classList.remove('active')); if(name==='calendar') document.getElementById('btnCal').classList.add('active'); if(name==='tasks') document.getElementById('btnTasks').classList.add('active'); if(name==='history') document.getElementById('btnHistory').classList.add('active'); if(name==='stats') document.getElementById('btnStats').classList.add('active'); }

/* ---------------- CALENDAR ---------------- */
function renderMonth(){ document.getElementById('monthLabel').textContent = currentDate.toLocaleString('sl', {month:'long', year:'numeric'}); }
function prevMonth(){ currentDate.setMonth(currentDate.getMonth()-1); renderMonth(); renderCalendar(); }
function nextMonth(){ currentDate.setMonth(currentDate.getMonth()+1); renderMonth(); renderCalendar(); }
function goToday(){ currentDate = new Date(); renderMonth(); renderCalendar(); }

function renderCalendar(){ const grid = document.getElementById('calendarGrid'); grid.innerHTML=''; const year=currentDate.getFullYear(), month=currentDate.getMonth(); const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month+1, 0).getDate(); for(let i=0;i<firstDay;i++){ const empty=document.createElement('div'); empty.className='cell empty'; grid.appendChild(empty); }
 for(let d=1; d<=daysInMonth; d++){ const cell=document.createElement('div'); cell.className='cell'; const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`; cell.dataset.date=dateStr; const badge=document.createElement('div'); badge.className='date-badge'; badge.textContent=d; cell.appendChild(badge);
   // tasks on that day
   const dayTasks = tasks.map((t,idx)=>({...t,idx})).filter(t=>t.date===dateStr);
   dayTasks.forEach(t=>{
     const el=document.createElement('div'); el.className='task'; el.style.borderLeftColor = t.color || '#ffc400'; let timesTxt=''; if(t.intervals && t.intervals.length){ const times = t.intervals.map(iv=>`${iv.start}-${iv.end}`); const total = t.intervals.reduce((s,iv)=>s + (iv.dur||0),0); timesTxt = `<div class="note" style="font-size:12px">${times.join(', ')} (${humanDuration(total)})</div>`; }
     el.innerHTML = `<div><div style=\"font-size:13px\">${t.title}</div><div class=\"note\">${t.worker}</div>${timesTxt}</div>`;
     const right=document.createElement('div'); right.style.display='flex'; right.style.flexDirection='column'; right.style.alignItems='flex-end'; const btn=document.createElement('button'); btn.className='btn'; btn.style.padding='6px 8px'; btn.style.borderRadius='8px'; btn.style.fontSize='12px'; if(t.completed) { btn.textContent='Zaključeno'; btn.style.background='rgba(29,185,84,0.12)'; } else { btn.textContent = (currentRole==='admin' || t.worker===currentUser) ? 'Zaključi' : 'Poglej'; btn.onclick = (ev)=>{ ev.stopPropagation(); openCompleteModal(t.idx); }; }
     btn.onclick = btn.onclick || (()=>{});
     right.appendChild(btn); el.appendChild(right);
     el.onclick = ()=>{ if(currentRole==='admin' || t.worker===currentUser) openCompleteModal(t.idx); else alert('Nimate pravice spreminjati naloga'); };
     cell.appendChild(el);
   });
   // click blank cell to add (only admin)
   cell.onclick = (ev)=>{ if(ev.target===cell && currentRole==='admin'){ openAddModal(dateStr); } };
   grid.appendChild(cell);
 }
}

/* ---------------- ADD TASK ---------------- */
function populateWorkerSelect(){ const sel=document.getElementById('newWorker'); sel.innerHTML=''; Object.keys(workers).forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent = workers[k].name || k; sel.appendChild(opt); }); }
function openAddModal(dateStr){ modalAddDate = dateStr; document.getElementById('modalDayLabel').textContent = dateStr; document.getElementById('newDate').value = dateStr; document.getElementById('newTitle').value=''; document.getElementById('newDesc').value=''; document.getElementById('addModal').style.display='flex'; }
function closeAddModal(){ document.getElementById('addModal').style.display='none'; }
function saveNewTask(){ const title=document.getElementById('newTitle').value.trim(); const date=document.getElementById('newDate').value; const desc=document.getElementById('newDesc').value.trim(); const worker=document.getElementById('newWorker').value; const color=document.getElementById('newColor').value; if(!title||!date||!worker){ alert('Naziv, datum in delavec so obvezni'); return; } const obj={ title, desc, date, worker, color, completed:false, intervals:[] }; tasks.push(obj); saveAll(); closeAddModal(); renderCalendar(); renderTasksPanel(); alert('Nalog dodan'); }

/* ---------------- COMPLETE / INTERVALS ---------------- */
function openCompleteModal(index){ completingIndex = index; const t = tasks[index]; document.getElementById('completeTitle').textContent = t.title + ' • ' + t.worker; // render existing intervals
 const list = document.getElementById('timeList'); list.innerHTML=''; (t.intervals||[]).forEach((iv, i)=>{ addTimeRowToList(iv.start, iv.end, iv.dur, i); }); document.getElementById('startInput').value=''; document.getElementById('endInput').value=''; document.getElementById('completeModal').style.display='flex'; }
function closeCompleteModal(){ document.getElementById('completeModal').style.display='none'; completingIndex=null; }
function addTimeRow(){ const s=document.getElementById('startInput').value; const e=document.getElementById('endInput').value; if(!s||!e){ alert('Vnesi oba časa'); return; } if(parseTimeToHours(e) <= parseTimeToHours(s)){ alert('Konec mora biti kasneje od začetka'); return; } // check overlap with existing rows in modal
 const existing = Array.from(document.querySelectorAll('#timeList .time-item')).map(n=>n.dataset.range).filter(Boolean); for(const r of existing){ const [rs,re]=r.split('|'); if(!(e <= rs || s >= re)){ alert('Interval se prekriva z že vpisanim intervalom'); return; } }
 // check also overlap with already saved intervals of task
 const t = tasks[completingIndex]; for(const iv of t.intervals || []){ if(!(e <= iv.start || s >= iv.end)){ alert('Interval se prekriva z obstoječim intervalom naloga'); return; } }
 const dur = diffHours(s,e); addTimeRowToList(s,e,dur);
 document.getElementById('startInput').value=''; document.getElementById('endInput').value=''; }
function addTimeRowToList(start,end,dur, idx=null){ const list = document.getElementById('timeList'); const row = document.createElement('div'); row.className='time-item'; row.dataset.range = `${start}|${end}`; row.innerHTML = `<div>${start} → ${end} (${humanDuration(dur)})</div>`; const controls=document.createElement('div'); const editBtn=document.createElement('button'); editBtn.textContent='Uredi'; editBtn.onclick = ()=>{ // open small prompt for editing
 const ns = prompt('Začetek (HH:MM)', start); if(!ns) return; const ne = prompt('Konec (HH:MM)', end); if(!ne) return; // basic checks
 if(parseTimeToHours(ne) <= parseTimeToHours(ns)){ alert('Konec mora biti kasneje'); return; }
 // remove and replace
 row.firstChild.textContent = `${ns} → ${ne} (${humanDuration(diffHours(ns,ne))})`; row.dataset.range = `${ns}|${ne}`; };
 const delBtn=document.createElement('button'); delBtn.textContent='Izbriši'; delBtn.onclick = ()=>{ list.removeChild(row); };
 controls.appendChild(editBtn); controls.appendChild(delBtn); row.appendChild(controls); list.appendChild(row); }
function submitComplete(){ if(completingIndex === null) return; const t = tasks[completingIndex]; // collect intervals from modal
 const rows = Array.from(document.querySelectorAll('#timeList .time-item')); if(rows.length===0){ alert('Dodaj vsaj en interval'); return; }
 const intervals = rows.map(r=>{ const [s,e]=r.dataset.range.split('|'); return { start:s, end:e, dur: diffHours(s,e) }; }); // final overlap check across intervals
 intervals.sort((a,b)=>parseTimeToHours(a.start)-parseTimeToHours(b.start)); for(let i=1;i<intervals.length;i++){ if(parseTimeToHours(intervals[i].start) < parseTimeToHours(intervals[i-1].end)){ alert('Intervali se med seboj prekrivajo — popravi.'); return; } }
 // also ensure intervals don't overlap with previously saved intervals (for safety)
 for(const iv of intervals){ for(const existing of t.intervals || []){ if(!(iv.end <= existing.start || iv.start >= existing.end)){ alert('Novi interval se prekriva z obstoječim intervalom naloga.'); return; } } }
 // save
 t.intervals = (t.intervals||[]).concat(intervals); t.completed = true; history.push({...t, finishedAt: new Date().toLocaleString()}); saveAll(); closeCompleteModal(); renderCalendar(); renderTasksPanel(); renderHistoryPanel(); renderStatsPanel(); alert('Nalog zaključen. Skupaj: '+ humanDuration(t.intervals.reduce((s,i)=>s + (i.dur||0),0))); }

/* ---------------- TASKS / HISTORY / STATS ---------------- */
function renderTasksPanel(){ const box=document.getElementById('taskListPanel'); box.innerHTML=''; tasks.forEach((t,idx)=>{ if(!t.completed){ if(currentRole==='admin' || t.worker===currentUser){ const row=document.createElement('div'); row.style.padding='10px'; row.style.marginBottom='8px'; row.style.borderRadius='8px'; row.style.background='#08120f'; row.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>${t.title}</strong><div class='note'>${t.date} • ${t.worker}</div></div><div>${ (currentRole==='admin' || t.worker===currentUser) ? `<button class='btn' onclick='openCompleteModal(${idx})'>Zaključi</button>` : ''}</div></div>`; box.appendChild(row); } } }); if(box.innerHTML==='') box.innerHTML='<div class="note center">Ni aktivnih nalog za prikaz</div>'; }
function renderHistoryPanel(){ const box=document.getElementById('historyPanel'); box.innerHTML=''; history.slice().reverse().forEach(h=>{ if(currentRole==='admin' || h.worker===currentUser){ const total = h.intervals ? h.intervals.reduce((s,i)=>s + (i.dur||0),0) : 0; const el = document.createElement('div'); el.style.padding='10px'; el.style.marginBottom='8px'; el.style.borderRadius='8px'; el.style.background='#08120f'; el.innerHTML = `<strong>${h.title}</strong> • ${h.worker} • ${h.date} <div class='note'>Trajanje: ${humanDuration(total)} • Zaključeno: ${h.finishedAt}</div>`; box.appendChild(el); } }); if(box.innerHTML==='') box.innerHTML='<div class="note center">Ni zgodovine</div>'; }
function renderStatsPanel(){ const panel=document.getElementById('statsPanel'); panel.innerHTML=''; const total=tasks.length; const done=history.length; const active=tasks.filter(t=>!t.completed).length; let totalHours = history.reduce((s,h)=> s + (h.intervals ? h.intervals.reduce((ss,i)=>ss + (i.dur||0),0) : 0 ), 0); const el=document.createElement('div'); el.innerHTML = `<div class='note'>Skupaj nalog: <strong>${total}</strong></div><div class='note'>Aktivnih: <strong>${active}</strong></div><div class='note'>Zaključenih: <strong>${done}</strong></div><div class='note'>Skupaj ur (zaključeno): <strong>${humanDuration(totalHours)}</strong></div>`; panel.appendChild(el); }

/* ---------------- EXPORT ---------------- */
function exportCSV(){ // build CSV of current month per worker or all
 const rows = [['Datum','Nalogo','Delavec','Intervali','Skupaj ur','Opis']]; tasks.forEach(t=>{ if(currentRole==='admin' || t.worker===currentUser){ const intervals = (t.intervals||[]).map(iv=>`${iv.start}-${iv.end}`).join(', '); const total = (t.intervals||[]).reduce((s,i)=>s + (i.dur||0),0); rows.push([t.date, t.title, t.worker, intervals, total, t.desc || '']); } }); const csv = rows.map(r=> r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n'); const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download = `report_${currentDate.getFullYear()}_${currentDate.getMonth()+1}.csv`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); }
async function exportPDF(){ // use jsPDF autotable
 const { jsPDF } = window.jspdf; const doc = new jsPDF(); const cols=[{header:'Datum',dataKey:'date'},{header:'Naloga',dataKey:'title'},{header:'Delavec',dataKey:'worker'},{header:'Intervali',dataKey:'intervals'},{header:'Ure',dataKey:'hours'}]; const data = []; tasks.forEach(t=>{ if(currentRole==='admin' || t.worker===currentUser){ const intervals = (t.intervals||[]).map(iv=>`${iv.start}-${iv.end}`).join(', '); const hours = (t.intervals||[]).reduce((s,i)=>s + (i.dur||0),0); data.push({ date:t.date, title:t.title, worker:t.worker, intervals, hours: humanDuration(hours) }); } }); doc.setFontSize(14); doc.text('Mesečno poročilo — ElektroWorks',14,18); doc.autoTable({ startY:28, head: [cols.map(c=>c.header)], body: data.map(r=> [r.date, r.title, r.worker, r.intervals, r.hours]) }); doc.save(`report_${currentDate.getFullYear()}_${currentDate.getMonth()+1}.pdf`); }

/* ---------------- UTIL ---------------- */
function parseTimeToHours(t){ const [h,m]=t.split(':').map(Number); return h + m/60; }
// expose functions
window.fillDemo = fillDemo; window.doLogin = doLogin; window.prevMonth = prevMonth; window.nextMonth = nextMonth; window.goToday = goToday; window.openAddModal = openAddModal; window.closeAddModal = closeAddModal; window.saveNewTask = saveNewTask; window.openCompleteModal = openCompleteModal; window.closeCompleteModal = closeCompleteModal; window.addTimeRow = addTimeRow; window.submitComplete = submitComplete; window.showPanel = showPanel; window.logout = logout; window.exportCSV = exportCSV; window.exportPDF = exportPDF; window.populateWorkerSelect = populateWorkerSelect; window.renderCalendar = renderCalendar; window.renderTasksPanel = renderTasksPanel; window.renderHistoryPanel = renderHistoryPanel; window.renderStatsPanel = renderStatsPanel; window.saveAll = saveAll;

// initialize selects and month label
populateWorkerSelect(); renderMonth();
</script>
</body>
</html>
